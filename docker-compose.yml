services:
  manager:
    develop:
      watch:
        - action: rebuild
          path: ./manager/src/
    build:
      context: ./
      dockerfile: ./manager/Dockerfile
      # scale: 3
    restart: unless-stopped
    depends_on:
      - pubsub
      - database
    networks:
      - ps
      - db
    environment:
      MONGODB_HOST: database
      REDIS_HOST: pubsub
      MANAGER_DATABASE: drz-mng-dc
      MONGODB_PORT: 27017
    volumes:
      - type: bind
        source: ./data/export
        target: /data/export
    ports:
      - '3000:3000'
      - '59982:59982'
  worker:
    develop:
      watch:
        - action: rebuild
          path: ./worker/src/
    build:
      context: ./
      dockerfile: ./worker/Dockerfile
    restart: unless-stopped
    depends_on:
      - pubsub
      - database
    networks:
      - ps
      - db
    environment:
      MONGODB_HOST: database
      REDIS_HOST: pubsub
      WORKER_DATABASE: drz-wrk-dc
      MONGODB_PORT: 27017
  pubsub:
    image: redis
    networks:
      - ps
    restart: unless-stopped
    ports:
      - '6378:6379'
  database:
    image: mongo
    restart:
      unless-stopped
      #environment:
      #  MONGO_INITDB_ROOT_USERNAME_FILE: /run/secrets/MONGODB_USER
      #  MONGO_INITDB_ROOT_PASSWORD_FILE: /run/secrets/MONGODB_PASS
    volumes:
      - type: bind
        source: ./data/db
        target: /data/db
    ports:
      - 27018:27017
    networks:
      - db
        #secrets:
        #  MONGODB_PORT:
        #    external: true
        #  MONGODB_USER:
        #    external: true
        #  MONGODB_PASS:
        #    external: true
networks:
  db:
    name: db
  ps:
    name: ps
