version: "3.8"

x-services:
  - &db mongo
  - &pubsub redis
  - &worker worker
  - &manager manager

services:
  *worker:
    build:
      context: ./
      dockerfile: ./Dockerfile.worker
        #scale: 3
    depends_on:
      - *pubsub
    networks:
      - pubsub
    environment:
      REDIS_HOST: *pubsub
  *pubsub:
    image: redis
    networks:
      - pubsub
  *manager:
    build:
      context: ./
      dockerfile: ./Dockerfile.manager
    depends_on:
      - redis
      - mongo
    networks:
      - pubsub
      - database
    environment:
      MONGODB_HOST: *db
      REDIS_HOST: *pubsub
    volumes:
      - type: bind
        source: ./data/seeds.txt
        target: /data/seeds.txt
      - type: bind
        source: ./data/export
        target: /data/export
  *db:
    image: mongo
    restart: always
      #environment:
      #  MONGO_INITDB_ROOT_USERNAME_FILE: /run/secrets/MONGODB_USER
      #  MONGO_INITDB_ROOT_PASSWORD_FILE: /run/secrets/MONGODB_PASS
    volumes:
      - type: bind
        source: ./data/db
        target: /data/db
    ports:
      - "27018:27017"
    networks:
      - database
        #secrets:
        #  MONGODB_PORT:
        #    external: true
        #  MONGODB_USER:
        #    external: true
        #  MONGODB_PASS:
        #    external: true
networks:
  database:
  pubsub:
